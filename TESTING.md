# Testing Guide for NexumDB

This document describes all testing and quality assurance processes for NexumDB.

## Local Testing

### Rust Tests
```bash
# Set PyO3 compatibility for Python 3.14
export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1

# Format check
cargo fmt --all -- --check

# Linting
cargo clippy --workspace --all-targets -- -D warnings

# Run tests (single-threaded for consistent results)
cargo test --workspace -- --test-threads=1

# Security audit
cargo audit

# Generate documentation
cargo doc --no-deps --workspace
```

### Python Tests
```bash
cd nexum_ai

# Lint with ruff
ruff check .

# Syntax check
python3 -m compileall *.py

# Run tests with coverage
pytest --cov=. --cov-report=xml --cov-report=html
```

## CI/CD Workflows

### Continuous Integration (.github/workflows/ci.yml)
Runs on: Every push and PR
- **Rust checks**:
  - Format check with `cargo fmt`
  - Linting with `cargo clippy`
  - Unit and integration tests
  - Security audit with `cargo audit`
  - Documentation build
  - Code coverage with `cargo-llvm-cov` → Codecov
  
- **Python checks**:
  - Linting with `ruff`
  - Syntax check with `compileall`
  - Tests with `pytest`
  - Coverage with `pytest-cov` → Codecov

- **Benchmarks** (PR only):
  - Criterion-based performance tests
  - Comparison with main branch

### Security Workflows

#### CodeQL Analysis (.github/workflows/codeql.yml)
Runs on: Push to main, PRs, weekly schedule
- Static security analysis for Python code
- Identifies potential vulnerabilities

#### Dependency Review (.github/workflows/dependency-review.yml)
Runs on: Pull requests
- Reviews dependency changes
- Fails on moderate+ severity vulnerabilities
- Comments summary in PR

#### SBOM Generation (.github/workflows/sbom.yml)
Runs on: Release tags
- Generates Software Bill of Materials
- Tracks all dependencies

### Code Quality

#### DCO Check (.github/workflows/dco.yml)
Runs on: Pull requests
- Verifies Developer Certificate of Origin
- Ensures proper commit sign-off

#### Stale Issues (.github/workflows/stale.yml)
Runs on: Schedule (daily)
- Marks inactive issues/PRs as stale
- Auto-closes after inactivity period

### Release & Distribution

#### Release Please (.github/workflows/release-please.yml)
Runs on: Push to main
- Automated release PR generation
- Version bumping based on conventional commits
- Changelog generation
- **Current Status**: Requires repository settings update (see RELEASE_PLEASE_FIX.md)

#### Docker Release (.github/workflows/docker-release.yml)
Runs on: Release tags
- Builds and publishes Docker images
- Multi-platform support

## Known Issues

### Unmaintained Dependencies
The following dependencies are flagged as unmaintained by `cargo audit`:
- `fxhash 0.2.1` - Used by sled (indirect)
- `instant 0.1.13` - Used by sled (indirect)

These are **warnings only**, not security vulnerabilities. They come from the `sled` database dependency. Monitor for:
- Updates to `sled` that might replace these
- Alternative database backends if needed
- Security advisories (none currently)

### Release Please Permissions
The Release Please workflow requires repository settings update. See `/tmp/release-please-fix.md` for instructions.

## Coverage Requirements

- **Target**: Maintain >80% code coverage
- **Tracking**: Codecov integration for both Rust and Python
- **Reports**: 
  - Rust: `lcov.info` generated by `cargo-llvm-cov`
  - Python: `coverage.xml` generated by `pytest-cov`

## Pre-commit Checklist

Before pushing changes:
1. Run `cargo fmt --all`
2. Run `cargo clippy --workspace --all-targets`
3. Run `cargo test --workspace`
4. Run `ruff check nexum_ai/` (if Python changes)
5. Run `pytest` in nexum_ai/ (if Python changes)
6. Ensure all tests pass locally
7. Sign commits with DCO (`git commit -s`)

## Continuous Improvement

Consider adding:
- [ ] Mutation testing for test quality assessment
- [ ] Performance regression detection
- [ ] Fuzzing for SQL parser
- [ ] Integration tests with real workloads
- [ ] Load testing scenarios
